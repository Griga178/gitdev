<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
  </head>
  <body>

    <a href="p.html">p.html</a> <br>
    <a href="p_2.html">p_2.html</a> <br>
    <a href="p_3.html">p_3.html</a> <br>
    <a href="p_4.html">p_4.html - active</a> <br>
    <br>

    <h3>Кастомные формы</h3>
    <p>форма 2 значения (только клик)</p>
    <p>форма >2 значений (клик + список)</p>
    <p>форма инпут (инпут + выбор)</p>
    <div class="form-block">

      <div class="field-row" tabindex="0" aria-label="Ожидаемый">

        <div class="field-cell"
          data-name="tag_name"
          data-key="div"
          data-dict='{"div": "div", "h1": "h1", "span": "span"}'>
          <span>div</span>
          <input class="field-input" type="text"  value="div">
          <div class="field-desc">Название атрибута</div>
        </div>

        <div class="field-cell"
          data-name="name"
          data-key="name"
          data-dict='{"name": "name", "price": "price", "price_vs_card": "price_vs_card"}'>
          <span>name</span>
          <div class="field-desc">Название элемента</div>
        </div>

        <div class="field-cell"
          data-name="type"
          data-key="Текст"
          data-dict='{"Текст": "str", "Число": "float"}'>
          <span>Текст</span>
          <div class="field-desc">Тип данных</div>
        </div>

        <div class="field-cell"
          data-name="is_expected"
          data-key="Да"
          data-dict='{"Да": true, "Нет": false}'>
          <span>Да</span>
          <div class="field-desc">Элемент ожидается на странице</div>
        </div>

      </div>

    </div>

    <script>

      document.querySelectorAll('.field-cell').forEach(cell => {
        const dict = JSON.parse(cell.getAttribute('data-dict'));
        const keys = Object.keys(dict);
        // Ищем span
        let span = cell.querySelector('span');
        // выпадающее меню - start
        if (keys.length > 2) {
          // создание блоков меню
          const options = document.createElement('div');
          options.classList.add('field-options');

          const arrow = document.createElement('div');
          arrow.classList.add('arrow');
          arrow.textContent = '▾';

          const dropdown = document.createElement('div');
          dropdown.classList.add('dropdown', 'hidden');
          // добавление блоков меню
          options.appendChild(arrow);
          options.appendChild(dropdown);
          cell.appendChild(options);
          // заполнение выпадающего меню
          keys.forEach(key => {
            const option = document.createElement('div');
            option.textContent = key;
            option.dataset.key = key;
            dropdown.appendChild(option);
          });
          // добавляем переключатель "стрелке"
          arrow.addEventListener('click', e => {
            e.stopPropagation();
            dropdown.classList.toggle('hidden');
          });
          // добавляем обработку пункта выпадающего меню
          dropdown.addEventListener('click', e => {
            if (e.target && e.target.dataset.key) {
              e.stopPropagation() // останавливает клик на общий блок
              const selectedKey = e.target.dataset.key;
              cell.setAttribute('data-key', selectedKey);
              span.textContent = selectedKey;
              dropdown.classList.add('hidden');
            }
          });
        }; // выпадающее меню - end
        // обработка клика по ячейке формы
        cell.addEventListener('click', () => {
          const input = cell.querySelector('.field-input');
          // если в форме есть - input клик активирует его
          // если нет, простое переключение по дефолтным значениям
          if (input) {
              // навешиваем обработчик blur один раз
              if (!input._blurHandler) {
                  input._blurHandler = () => {
                      const newValue = input.value.trim();
                      if (newValue) {
                          span.textContent = newValue;
                          cell.setAttribute('data-key', newValue);

                          let dict = JSON.parse(cell.getAttribute('data-dict') || '{}');
                          dict[newValue] = newValue;
                          cell.setAttribute('data-dict', JSON.stringify(dict));

                          const dropdown = document.querySelector('.dropdown');
                          // Проверяем, нет ли уже такого ключа, чтобы избежать дубликата
                          if (![...dropdown.children].some(child => child.dataset.key === newValue)) {
                              const option = document.createElement('div');
                              option.textContent = newValue;
                              option.dataset.key = newValue;
                              dropdown.appendChild(option);
                          }
                      }
                      span.style.display = 'inline';
                      input.style.display = 'none';
                  };
                  input.addEventListener('blur', input._blurHandler);
              }
              // добавим обработчик Enter для закрытия инпута
              if (!input._enterHandler) {
                input._enterHandler = (e) => {
                  if (e.key === 'Enter') {
                    input.blur(); // триггерим blur, чтобы закрыть и сохранить
                  }
                };
                input.addEventListener('keydown', input._enterHandler);
              }

              span.style.display = 'none';
              input.style.display = 'inline-block';
              input.focus();
          } else {
              // простое переключение по словарю
              const currentKey = cell.getAttribute('data-key');
              const dict = JSON.parse(cell.getAttribute('data-dict') || '{}');
              const keys = Object.keys(dict);
              const currentIndex = keys.indexOf(currentKey);
              const nextIndex = (currentIndex + 1) % keys.length;
              const nextKey = keys[nextIndex];

              cell.setAttribute('data-key', nextKey);
              span.textContent = nextKey;
          }
        });

      });

      // Скрытие всех dropdown при клике вне
      document.addEventListener('click', () => {
        document.querySelectorAll('.dropdown').forEach(dropdown => {
          dropdown.classList.add('hidden');
        });
      });

    </script>

    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: var(--main-text-color);
      }
      /* Объявление переменных */
      :root {
        /* Цвета */
        --desc-text-color: #666;
        --desc-text-font-size: 12px;
        --form-background-color: #f8f9fa;
        --main-text-color: #212529;
      }
      .field-desc {
        font-size: var(--desc-text-font-size);
        color: var(--desc-text-color);
        margin-top: 3px; /* убрать от сюда */
        font-weight: 400;
        text-align: center;
      }
      .field-input {
        border: 1px solid #ddd;
        border-radius: 8px;
        text-align: center;
        display: none;
      }
      /* общий контейнер */
      .form-block {
        background: var(--form-background-color);
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px 25px;
        user-select: none;
        display: flex;
        flex-direction: column;
        grid-row-gap: 32px;
        align-items: center;
      }

      /* горизонтальный блок */
      .field-row {
        position: relative;
        display: flex;
        flex-direction: row;
        align-items: stretch;
        grid-column-gap: 16px;
        padding: 6px 12px;
        font-weight: 600;
        min-width: 100px;
        min-height: 32px;
      }
      /* редактируемая ячейка */
      .field-cell {
        position: relative;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 8px 16px;
        border-radius: 8px;
        width: 100%;
      }
      .field-options {
        position: relative;
        margin-top: 4px;
        user-select: none;
      }
      .arrow {
        font-size: 14px;
        cursor: pointer;
        user-select: none;
        width: 64px;
        height: 18px;
        padding-right: 2px;
        text-align: center;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
      .arrow:hover{
        background-color: white;
      }
      .dropdown {
        position: absolute;
        top: 20px;
        left: 0;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        z-index: 100;
        min-width: 100px;
      }

      .dropdown div {
        padding: 6px 12px;
        cursor: pointer;
      }

      .dropdown div:hover {
        background-color: #eee;
      }

      .hidden {
        display: none;
      }
      .field-cell:hover{
        background-color: rgba(0, 0, 0, 0.1);
      }
      /* Добавляем линию слева у всех кроме первого */
      .field-cell:not(:first-child)::before {
        content: "";
        position: absolute;
        left: -8px;
        top: 0;       /* отступ сверху, чтобы линия была короче */
        bottom: 0;    /* отступ снизу */
        width: 1px;
        background-color: #ccc; /* цвет линии */
      }
    </style>


  </body>
</html>
