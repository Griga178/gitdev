<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
  </head>
  <body>

    <a href="p.html">p.html</a> <br>
    <a href="p_2.html">p_2.html</a> <br>
    <a href="p_3.html">p_3.html - active</a> <br>
    <a href="p_4.html">p_4.html</a> <br>
    <br>

<div class="form-block">
  <form id="fieldForm" novalidate>
    <!-- Первая форма с возможностью ввода своего варианта -->
    <div class="field-row" title="Выберите или введите название поля" tabindex="0" aria-label="Название">
      <span class="field-text" contenteditable="true" role="textbox" aria-multiline="false" aria-placeholder="Введите или выберите...">price</span>
      <select class="field-select" name="fieldName" aria-hidden="true">
        <option value="price" selected>price</option>
        <option value="name">name</option>
        <option value="discount_price">discount_price</option>
      </select>
      <div class="field-desc">Название поля (можно ввести своё)</div>
    </div>

    <div class="field-row" title="Выберите тип данных" tabindex="0" aria-label="Тип данных">
      <span class="field-text">float</span>
      <select class="field-select" name="fieldType" aria-hidden="true">
        <option value="float" selected>float</option>
        <option value="str">str</option>
      </select>
      <div class="field-desc">Тип данных поля</div>
    </div>

    <div class="field-row" title="Выберите, ожидается ли поле" tabindex="0" aria-label="Ожидаемый">
      <span class="field-text" id="expected-value" style="cursor:pointer; user-select:none;">yes</span>
      <button
        aria-pressed="true"
        aria-label="Ожидаемый"
        id="expected-toggle"
        type="button"
        style="position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; border: 0;"
      >yes</button>
      <div class="field-desc">Ожидается ли заполнение поля</div>
    </div>

  </form>
</div>

<style>
  .form-block {
    max-width: 600px;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px 25px;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    user-select: none;
  }

  form {
    display: flex;
    justify-content: space-between;
    gap: 15px;
  }

  .field-row {
    position: relative;
    flex: 1;
    cursor: pointer;
    padding: 6px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    font-weight: 600;
    color: #212529;
    border-left: 1px solid #ccc;
    min-width: 100px;
  }

  .field-row:first-child {
    border-left: none;
  }

  .field-text {
    width: 100%;
    text-align: center;
    pointer-events: auto; /* Чтобы можно было редактировать */
    outline: none;
    border-radius: 4px;
    padding: 2px 4px;
    cursor: text;
  }

  /* Селект скрытый, но активный */
  .field-select {
    position: absolute;
    top: 28px;
    left: 50%;
    transform: translateX(-50%);
    width: max-content;
    min-width: 100%;
    z-index: 10;
    font-size: 14px;
    opacity: 0;
    pointer-events: auto;
    cursor: pointer;
  }

  /* Показать селект при фокусе или наведении по всему блоку */
  .field-row:hover .field-select,
  .field-select:focus {
    opacity: 1;
    pointer-events: auto;
    position: relative;
    transform: none;
    background: white;
    border: 1px solid #aaa;
    border-radius: 4px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }

  /* Подсветка при фокусе/наведении .field-row */
  .field-row:hover,
  .field-row:focus-within {
    background-color: #e2e6ea;
    outline: none;
  }

  .field-desc {
    font-size: 12px;
    color: #666;
    margin-top: 3px;
    user-select: text;
    font-weight: 400;
  }
</style>

<script>
  const button = document.getElementById('expected-toggle');
  const text = document.getElementById('expected-value');

  // Обработка клика по тексту, которая переключает состояние кнопки
  text.addEventListener('click', () => {
    button.click();
  });

  // При клике на кнопку меняем состояние и текст
  button.addEventListener('click', () => {
    const isYes = button.getAttribute('aria-pressed') === 'true';

    if (isYes) {
      button.setAttribute('aria-pressed', 'false');
      button.textContent = 'no';
      text.textContent = 'no';
    } else {
      button.setAttribute('aria-pressed', 'true');
      button.textContent = 'yes';
      text.textContent = 'yes';
    }
  });

  // остальное
  const form = document.getElementById('fieldForm');

  // Обновляем текст при выборе в селекте
  form.querySelectorAll('.field-row').forEach(row => {
    const span = row.querySelector('.field-text');
    const select = row.querySelector('select');

    // При изменении селекта выставляем текст
    select.addEventListener('change', () => {
      span.textContent = select.value;
      // Если поле с вводом собственного варианта - синхронизируем select и span
      if(span.isContentEditable) {
        // При выборе из селекта обновляем span (на случай, если был введён текст)
        span.textContent = select.value;
      }
    });

    // Для редактируемого span (первая форма) — обновляем select по вводу
    if (span.isContentEditable) {
      span.addEventListener('input', () => {
        const val = span.textContent.trim();
        // Если значение совпадает с одним из option — выбираем его, иначе добавляем/выбираем кастом
        let found = false;
        for(let opt of select.options) {
          if(opt.value === val) {
            select.value = val;
            found = true;
            break;
          }
        }
        if (!found) {
          // Добавим option с новым значением, если его нет
          let existingCustom = select.querySelector('option.custom-input');
          if(existingCustom) {
            existingCustom.value = val;
            existingCustom.textContent = val;
          } else {
            const newOpt = new Option(val, val, true, true);
            newOpt.classList.add('custom-input');
            select.appendChild(newOpt);
          }
          select.value = val;
        }
      });

      // При потере фокуса, если пусто — вернуть на default
      span.addEventListener('blur', () => {
        if(span.textContent.trim() === '') {
          span.textContent = select.value || 'price';
          if(select.value === '') select.value = 'price';
        }
      });
    }
  });
</script>

  </body>
</html>
