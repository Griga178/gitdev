# Описание модуля и менеджера работы с КТРУ

## Модуль парсинга и работы с КТРУ

Модуль содержит функции для парсинга характеристик КТРУ с сайта **zakupki.gov**. Основные возможности модуля:

- Получение информации о КТРУ по номеру с сайта.
- Парсинг версии КТРУ, её характеристик и упорядочивание данных.
- Обработка возможных ошибок сетевого запроса и некорректных данных.
- Интеграция с базой данных для сохранения и обновления информации.

### Основные методы менеджера

- **get_ktru_info(ktru_number)**  
  Запрашивает информацию по номеру КТРУ.  
  - Если КТРУ с таким номером есть в базе — возвращает сохранённые данные.  
  - Если отсутствует в базе — запускает функцию парсинга с сайта, сохраняет данные в БД и возвращает их пользователю.

- **update_all_ktru()**  
  Производит обновление всех записей КТРУ в базе. Поочерёдно для каждого КТРУ выполняет парсинг последней версии с сайта, обновляет данные и сохраняет их.


## Таблицы

- **ktru**  
  Хранит основные данные по КТРУ:  
  - `id` — уникальный идентификатор (целое число)  
  - `number` — номер КТРУ (текст, уникальный)  
  - `name` — наименование КТРУ (текст)  
  - `unit` — единица измерения (текст)  
  - `ownCharsIsForbidden` — запрет задания собственных характеристик (логический тип)

- **ktruVersion**  
  Версии КТРУ, связанные с конкретным элементом из таблицы ktru:  
  - `id` — уникальный идентификатор  
  - `ktruId` — внешний ключ на таблицу ktru  
  - `versionNumber` — номер версии (целое число)  
  - `dateUpdate` — дата обновления версии (дата и время)

- **ktruChars**  
  Характеристики КТРУ для каждой версии:  
  - `id` — уникальный идентификатор  
  - `ktruVersionId` — внешний ключ на таблицу ktruVersion  
  - `name` — название характеристики (текст)  
  - `values` — возможные значения характеристики (текст)  
  - `unit` — единица измерения характеристики (текст)

- **requests**  
  Сохранение информации о запросах к сайту:  
  - `id` — уникальный идентификатор  
  - `isSuccess` — результат запроса (логический тип)  
  - `ktruNumber` — номер КТРУ, по которому был запрос (текст)  
  - `ktruVersion` — версия КТРУ (целое число)  
  - `date` — дата и время запроса (дата и время)

## Особенности

- Используется SQLAlchemy ORM для удобной работы с таблицами и связями.
- Имеются связи «один-ко-многим»:  
  - ktru → ktruVersion  
  - ktruVersion → ktruChars
- Все даты хранятся в формате datetime.
- Структура ориентирована на поддержание историй версий и характеристик КТРУ.


## Проектная структура

├── project/
│   ├── controller/
│   ├── init.py
│   ├── controller.py     — высокоуровневая логика, координация
├── db/
│   ├── init.py
│   ├── client.py         — обёртка по работе с БД (подключение, сессии)
│   ├── queries.py        — CRUD ─ функции, SQL ─ запросы
│   ├── models.py         — ORM ─ модели или DTO для БД
├── parser/
│   ├── init.py
│   ├── fetcher.py        — HTTP - клиенты, получение сырого контента
│   ├── extractor.py      — парсинг/извлечение данных (BeautifulSoup, regex и т.п.)
│   ├── normalizer.py     — приведение данных к единому формату
├── services/
│   ├──  init.py
│   ├── business.py       — бизнес ─ логика, объединение парсера и БД
│   ├── validators.py     — валидация входных данных
│   ├── tasks.py          — фоновые задачи, планировщик (опционально)
├── utils/
│   ├── init.py
│   ├── logging.py        — настроенный логгер
│   ├── config.py         — загрузка конфигурации (env, yaml)
│   ├── helpers.py        — утилитарные функции
├── tests/
│   ├── test_db.py
│   ├── test_parser.py
│   ├── test_manager.py

├── setup.py / pyproject.toml
├── README.md

## requirements:
requests
beautifulsoup4
sqlalchemy
pytest
requests-mock
